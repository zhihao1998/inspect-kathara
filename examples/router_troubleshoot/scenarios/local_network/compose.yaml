# Auto-generated from Kathara lab.conf
# Machines: management, pc1, router, pc2
# Networks: lan1, lan2

services:
  default:
    image: kathara/base
    x-local: true
    init: true
    hostname: management
    cap_add: &id001
    - NET_ADMIN
    networks: &id002
    - lan1
    - lan2
    command: sleep infinity
  management:
    image: kathara/base
    x-local: true
    init: true
    hostname: management
    cap_add: *id001
    networks: *id002
    command: sh -lc 'for d in $(ls /sys/class/net | grep -v lo); do ip addr flush
      dev "$$d"; done; for d in $(ls /sys/class/net | grep -v lo); do ip route flush
      dev "$$d"; done; ip addr add 10.0.1.100/24 dev eth0 && ip link set eth0 up &&
      ip addr add 10.0.2.100/24 dev eth1 && ip link set eth1 up && mkdir -p /root/.ssh
      && echo "Host *" > /root/.ssh/config && echo "    StrictHostKeyChecking no"
      >> /root/.ssh/config && echo "    UserKnownHostsFile /dev/null" >> /root/.ssh/config
      && echo "    LogLevel ERROR" >> /root/.ssh/config && chmod 600 /root/.ssh/config
      && sleep infinity'
  pc1:
    image: kathara/base
    x-local: true
    init: true
    hostname: pc1
    cap_add: *id001
    networks:
    - lan1
    volumes:
    - /home/p4/codes/inspect-kathara/examples/router_troubleshoot/scenarios/local_network/topology/pc1:/tmp/config:ro
    command: sh -lc 'for d in $(ls /sys/class/net | grep -v lo); do ip addr flush
      dev "$$d"; done; for d in $(ls /sys/class/net | grep -v lo); do ip route flush
      dev "$$d"; done; cp -r /tmp/config/* / && ip addr add 10.0.1.10/24 dev eth0
      && ip link set eth0 up && ip route add default via 10.0.1.1 && mkdir -p /etc/ssh
      && echo "PermitRootLogin yes" >> /etc/ssh/sshd_config && echo "PermitEmptyPasswords
      yes" >> /etc/ssh/sshd_config && passwd -d root 2>/dev/null || true && /etc/init.d/ssh
      start 2>/dev/null || service ssh start 2>/dev/null || true && sleep infinity'
  router:
    image: kathara/frr
    x-local: true
    init: true
    hostname: router
    cap_add:
    - NET_ADMIN
    - SYS_ADMIN
    sysctls:
      net.ipv4.ip_forward: '1'
    networks:
    - lan1
    - lan2
    healthcheck:
      test:
      - CMD-SHELL
      - pgrep -f frr
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s
    command: sh -lc 'for d in $(ls /sys/class/net | grep -v lo); do ip addr flush
      dev "$$d"; done; for d in $(ls /sys/class/net | grep -v lo); do ip route flush
      dev "$$d"; done; ip addr add 10.0.1.1/24 dev eth0 && ip link set eth0 up &&
      ip addr add 10.0.2.1/24 dev eth1 && ip link set eth1 up && mkdir -p /etc/ssh
      && echo "PermitRootLogin yes" >> /etc/ssh/sshd_config && echo "PermitEmptyPasswords
      yes" >> /etc/ssh/sshd_config && passwd -d root 2>/dev/null || true && /etc/init.d/ssh
      start 2>/dev/null || service ssh start 2>/dev/null || true && echo 1 > /proc/sys/net/ipv4/ip_forward
      2>/dev/null || sysctl -w net.ipv4.ip_forward=1 2>/dev/null || true && sleep
      infinity'
  pc2:
    image: kathara/base
    x-local: true
    init: true
    hostname: pc2
    cap_add: *id001
    networks:
    - lan2
    command: sh -lc 'for d in $(ls /sys/class/net | grep -v lo); do ip addr flush
      dev "$$d"; done; for d in $(ls /sys/class/net | grep -v lo); do ip route flush
      dev "$$d"; done; ip addr add 10.0.2.10/24 dev eth0 && ip link set eth0 up &&
      ip route add default via 10.0.2.1 && mkdir -p /etc/ssh && echo "PermitRootLogin
      yes" >> /etc/ssh/sshd_config && echo "PermitEmptyPasswords yes" >> /etc/ssh/sshd_config
      && passwd -d root 2>/dev/null || true && /etc/init.d/ssh start 2>/dev/null ||
      service ssh start 2>/dev/null || true && sleep infinity'
networks:
  lan1:
    driver: bridge
    internal: true
    enable_ipv6: true
    enable_ipv4: false
    ipam:
      config: []
  lan2:
    driver: bridge
    internal: true
    enable_ipv6: true
    enable_ipv4: false
    ipam:
      config: []
